import React, { useState, useEffect, useRef, useMemo } from 'react';
import { 
  User, 
  CheckCircle2, 
  XCircle, 
  Loader2, 
  Eraser, 
  Check, 
  LayoutDashboard, 
  Download, 
  ArrowLeft,
  Search,
  Lock,
  X,
  Upload,
  Users,
  FileSignature,
  Trash2,
  Eye,
  Settings,
  Edit2,
  Save,
  UserPlus,
  RefreshCw
} from 'lucide-react';

/**
 * ==========================================
 * 설정 (관리자 및 API 설정)
 * ==========================================
 */
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxlzFcUau4mNLQOFn32VBTE7JG6b741_70vidAIz0CR52yfEvokhhJr_W4oaX0__8oZ/exec"; // 배포된 GAS 웹 앱 URL을 입력하세요.
const ADMIN_PASSWORD = "1234"; // 관리자 모드 기본 비밀번호

const App = () => {
  // 화면 단계 관리 (1: 조회, 2: 서명, 3: 완료, 4: 관리자)
  const [step, setStep] = useState(1);
  const [adminTab, setAdminTab] = useState('management'); // 'management', 'logs'
  
  // 프로그램 설정
  const [programName, setProgramName] = useState('2024 스마트 미래 교육 연수');
  const [defaultCourse, setDefaultCourse] = useState('기본 과정');
  
  // 연수 대상자 데이터베이스
  const [trainees, setTrainees] = useState([
    { id: '1', name: '홍길동', org: '서울초등학교', phone: '010-1234-5678', course: 'AI 교육과정' },
    { id: '2', name: '김철수', org: '경기중학교', phone: '010-9876-1234', course: '디지털 리터러시' }
  ]);

  // 등록 및 서명 로그 데이터베이스
  const [registrations, setRegistrations] = useState([]);
  
  // 동적 과정명 추출 (DB 내 존재하는 모든 고유 과정명)
  const existingCourses = useMemo(() => {
    return [...new Set(trainees.map(t => t.course))].sort();
  }, [trainees]);

  // 과정명 일괄 수정을 위한 임시 맵
  const [courseEditMap, setCourseEditMap] = useState({});

  // 관리자 수정/추가 상태
  const [editingId, setEditingId] = useState(null);
  const [editFormData, setEditFormData] = useState({ name: '', org: '', phone: '', course: '' });
  const [isAddingManually, setIsAddingManually] = useState(false);
  const [newTrainee, setNewTrainee] = useState({ name: '', org: '', phone: '', course: '' });
  
  // 관리자 선택 삭제 상태
  const [selectedIds, setSelectedIds] = useState([]);

  // 사용자 조회 및 등록 프로세스 상태
  const [inputValue, setInputValue] = useState('');
  const [loading, setLoading] = useState(false);
  const [userList, setUserList] = useState([]); 
  const [selectedUser, setSelectedUser] = useState(null);
  const [message, setMessage] = useState({ type: '', text: '' });
  const [scriptsLoaded, setScriptsLoaded] = useState(false);
  
  // 모달 제어
  const [isAdminModalOpen, setIsAdminModalOpen] = useState(false);
  const [adminPasswordInput, setAdminPasswordInput] = useState('');
  const [viewSignature, setViewSignature] = useState(null); 

  const sigCanvas = useRef(null);
  const sigPad = useRef(null);
  const fileInputRef = useRef(null);

  /**
   * 외부 라이브러리 동적 로드 (SignaturePad, XLSX, ExcelJS)
   */
  useEffect(() => {
    const loadScripts = async () => {
      const libraries = [
        { id: 'signature-pad-script', src: 'https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js' },
        { id: 'xlsx-script', src: 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js' },
        { id: 'exceljs-script', src: 'https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js' }
      ];

      for (const lib of libraries) {
        if (!document.getElementById(lib.id)) {
          await new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.id = lib.id;
            script.src = lib.src;
            script.async = true;
            script.onload = resolve;
            script.onerror = reject;
            document.body.appendChild(script);
          });
        }
      }
      setScriptsLoaded(true);
    };

    loadScripts().catch(() => showToast('error', '라이브러리 로드에 실패했습니다.'));
  }, []);

  /**
   * 서명 패드 초기화 및 캔버스 좌표 보정
   */
  useEffect(() => {
    if (step === 2 && sigCanvas.current && scriptsLoaded && window.SignaturePad) {
      const resizeCanvas = () => {
        const canvas = sigCanvas.current;
        if (!canvas) return;
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width * ratio;
        canvas.height = rect.height * ratio;
        const ctx = canvas.getContext("2d");
        ctx.scale(ratio, ratio);
        if (sigPad.current) sigPad.current.clear();
      };

      sigPad.current = new window.SignaturePad(sigCanvas.current, {
        minWidth: 1.5, maxWidth: 3.5, penColor: 'rgb(30, 58, 138)'
      });
      
      const timeoutId = setTimeout(resizeCanvas, 50);
      window.addEventListener("resize", resizeCanvas);
      return () => {
        window.removeEventListener("resize", resizeCanvas);
        clearTimeout(timeoutId);
      };
    }
  }, [step, scriptsLoaded]);

  const showToast = (type, text) => {
    setMessage({ type, text });
    setTimeout(() => setMessage({ type: '', text: '' }), 3000);
  };

  /**
   * 관리자 인증
   */
  const handleAdminToggle = () => {
    if (step === 4) setStep(1);
    else setIsAdminModalOpen(true);
  };

  const verifyAdminPassword = (e) => {
    e.preventDefault();
    if (adminPasswordInput === ADMIN_PASSWORD) {
      setStep(4);
      setIsAdminModalOpen(false);
      setAdminPasswordInput('');
      showToast('success', '관리자 모드 진입 성공');
    } else {
      showToast('error', '비밀번호가 일치하지 않습니다.');
    }
  };

  /**
   * 과정명 일괄 변경 (데이터베이스 동기화)
   */
  const handleCourseGlobalUpdate = (oldName) => {
    const newName = courseEditMap[oldName];
    if (!newName || newName === oldName) return;

    // 전체 명단 및 등록 로그의 과정명 일괄 수정
    setTrainees(prev => prev.map(t => t.course === oldName ? { ...t, course: newName } : t));
    setRegistrations(prev => prev.map(r => r.course === oldName ? { ...r, course: newName } : r));

    const newMap = { ...courseEditMap };
    delete newMap[oldName];
    setCourseEditMap(newMap);

    showToast('success', `'${oldName}' 과정이 '${newName}'으로 일괄 변경되었습니다.`);
  };

  /**
   * 연수 대상자 편집 및 수동 추가
   */
  const startEditing = (trainee) => {
    setEditingId(trainee.id);
    setEditFormData({ ...trainee });
  };

  const saveEdit = () => {
    setTrainees(prev => prev.map(t => t.id === editingId ? { ...editFormData } : t));
    setEditingId(null);
    showToast('success', '정보가 수정되었습니다.');
  };

  const addIndividualTrainee = () => {
    if (!newTrainee.name || !newTrainee.phone) {
      showToast('error', '성함과 연락처는 필수입니다.');
      return;
    }
    const trainee = {
      ...newTrainee,
      id: Date.now() + '',
      course: newTrainee.course || defaultCourse
    };
    setTrainees(prev => [trainee, ...prev]);
    setNewTrainee({ name: '', org: '', phone: '', course: '' });
    setIsAddingManually(false);
    showToast('success', '대상자가 추가되었습니다.');
  };

  /**
   * 삭제 로직
   */
  const deleteSelectedTrainees = () => {
    if (selectedIds.length === 0) return;
    setTrainees(prev => prev.filter(t => !selectedIds.includes(t.id)));
    setSelectedIds([]);
    showToast('success', '선택한 대상자가 삭제되었습니다.');
  };

  const toggleSelectAll = () => {
    if (selectedIds.length === trainees.length) setSelectedIds([]);
    else setSelectedIds(trainees.map(t => t.id));
  };

  const toggleSelectOne = (id) => {
    setSelectedIds(prev => prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]);
  };

  /**
   * 엑셀 파일 업로드
   */
  const handleFileUpload = (e) => {
    const file = e.target.files[0];
    if (!file || !window.XLSX) return;

    const reader = new FileReader();
    reader.onload = (evt) => {
      const bstr = evt.target.result;
      const wb = window.XLSX.read(bstr, { type: 'binary' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const data = window.XLSX.utils.sheet_to_json(ws);

      const newTrainees = data.map((item, idx) => ({
        id: Date.now() + idx + '',
        name: item['성함'] || item['이름'] || '이름없음',
        org: item['소속'] || '소속없음',
        phone: String(item['전화번호'] || item['번호'] || '010-0000-0000'),
        course: item['과정명'] || item['과정'] || defaultCourse
      }));

      setTrainees(prev => [...prev, ...newTrainees]);
      showToast('success', `${newTrainees.length}명의 명단이 로드되었습니다.`);
      e.target.value = ''; 
    };
    reader.readAsBinaryString(file);
  };

  /**
   * 사용자 조회 (전화번호 뒤 4자리 검색)
   */
  const handleSearch = () => {
    if (inputValue.length !== 4) {
      showToast('error', '4자리를 입력해주세요.');
      return;
    }
    setLoading(true);
    setTimeout(() => {
      const found = trainees.filter(t => t.phone.replace(/[^0-9]/g, '').slice(-4) === inputValue);
      if (found.length > 0) {
        setUserList(found);
        if (found.length === 1) {
          setSelectedUser(found[0]);
          setStep(2);
        }
      } else {
        showToast('error', '등록되지 않은 정보입니다.');
      }
      setLoading(false);
    }, 600);
  };

  /**
   * 등록 프로세스 완료
   */
  const handleRegister = () => {
    if (!sigPad.current || sigPad.current.isEmpty()) {
      showToast('error', '서명을 해주세요.');
      return;
    }

    const signatureData = sigPad.current.toDataURL();
    const newReg = {
      ...selectedUser,
      regTime: new Date().toLocaleString(),
      signature: signatureData
    };

    setLoading(true);
    setTimeout(() => {
      setRegistrations(prev => [...prev, newReg]);
      setLoading(false);
      setStep(3);
      setTimeout(() => {
        setStep(1);
        setInputValue('');
        setSelectedUser(null);
        setUserList([]);
      }, 3000);
    }, 800);
  };

  /**
   * 서명 이미지 포함 엑셀 출력 (ExcelJS)
   */
  const exportRegistrationBook = async () => {
    if (!window.ExcelJS) {
      showToast('error', '엑셀 라이브러리 로딩 중...');
      return;
    }

    const workbook = new window.ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('연수등록부');

    worksheet.mergeCells('A1:E1');
    worksheet.getCell('A1').value = `${programName} 등록부`;
    worksheet.getCell('A1').font = { size: 16, bold: true };
    worksheet.getCell('A1').alignment = { vertical: 'middle', horizontal: 'center' };

    worksheet.getRow(3).values = ['순번', '과정명', '성함', '소속', '서명'];
    worksheet.columns = [
      { width: 8 }, { width: 25 }, { width: 15 }, { width: 25 }, { width: 20 }
    ];

    for (let i = 0; i < registrations.length; i++) {
      const reg = registrations[i];
      const rowNum = i + 4;
      const row = worksheet.getRow(rowNum);
      row.values = [i + 1, reg.course, reg.name, reg.org, ''];
      row.height = 40; 
      row.alignment = { vertical: 'middle', horizontal: 'center' };

      if (reg.signature) {
        const imageId = workbook.addImage({
          base64: reg.signature,
          extension: 'png',
        });
        worksheet.addImage(imageId, {
          tl: { col: 4, row: rowNum - 1 },
          ext: { width: 80, height: 40 }
        });
      }
    }

    const buffer = await workbook.xlsx.writeBuffer();
    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `연수등록부_${new Date().toLocaleDateString()}.xlsx`;
    link.click();
  };

  const handleKeyClick = (val) => {
    if (val === 'DEL') setInputValue(prev => prev.slice(0, -1));
    else if (inputValue.length < 4) setInputValue(prev => prev + val);
  };

  return (
    <div className="min-h-screen bg-slate-50 flex flex-col font-sans text-slate-900 select-none overflow-hidden relative">
      {/* Toast Notification */}
      {message.text && (
        <div className={`fixed top-4 left-1/2 -translate-x-1/2 z-[150] px-6 py-3 rounded-full shadow-2xl text-white font-bold flex items-center gap-2 animate-bounce ${message.type === 'error' ? 'bg-red-500' : 'bg-[#1E3A8A]'}`}>
          {message.type === 'error' ? <XCircle size={20} /> : <CheckCircle2 size={20} />}
          {message.text}
        </div>
      )}

      {/* Admin Auth Modal */}
      {isAdminModalOpen && (
        <div className="fixed inset-0 z-[110] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-in fade-in duration-200">
          <div className="bg-white w-full max-w-sm rounded-3xl shadow-2xl p-6 animate-in zoom-in-95">
            <div className="flex justify-between items-center mb-6">
              <h3 className="text-xl font-bold text-[#1E3A8A] flex items-center gap-2"><Lock size={20}/>관리자 인증</h3>
              <button onClick={() => setIsAdminModalOpen(false)}><X className="text-slate-300 hover:text-slate-600" /></button>
            </div>
            <form onSubmit={verifyAdminPassword}>
              <input 
                type="password" value={adminPasswordInput} onChange={(e) => setAdminPasswordInput(e.target.value)}
                placeholder="Password" autoFocus
                className="w-full h-14 bg-slate-50 border-2 border-slate-100 rounded-2xl px-4 text-center text-2xl tracking-[0.5em] focus:border-[#1E3A8A] focus:outline-none mb-4"
              />
              <button type="submit" className="w-full py-4 bg-[#1E3A8A] text-white rounded-2xl font-bold shadow-lg active:scale-95 transition-all">확인</button>
            </form>
          </div>
        </div>
      )}

      {/* Signature Preview Modal */}
      {viewSignature && (
        <div className="fixed inset-0 z-[120] flex items-center justify-center p-4 bg-black/80" onClick={() => setViewSignature(null)}>
          <div className="bg-white p-2 rounded-xl max-w-lg w-full shadow-2xl animate-in zoom-in-95">
            <img src={viewSignature} alt="서명" className="w-full h-auto" />
            <p className="text-center text-slate-400 text-[10px] p-4 font-black tracking-widest">TAP TO CLOSE</p>
          </div>
        </div>
      )}

      {/* Header */}
      <header className="bg-[#1E3A8A] text-white p-5 shadow-lg flex justify-between items-center shrink-0 z-10">
        <div>
          <h1 className="text-xl font-black tracking-tight flex items-center gap-2 uppercase">
            Smart Sign-In <span className="bg-blue-500 text-[10px] px-2 py-0.5 rounded-full font-normal">PRO</span>
          </h1>
          <p className="text-blue-200 text-xs font-medium">{programName}</p>
        </div>
        <button 
          onClick={handleAdminToggle}
          className={`p-2.5 rounded-2xl transition-all ${step === 4 ? 'bg-white text-[#1E3A8A] rotate-90 shadow-lg' : 'bg-blue-700/50 text-white hover:bg-blue-600'}`}
        >
          {step === 4 ? <X size={20} /> : <LayoutDashboard size={20} />}
        </button>
      </header>

      {/* Main Container */}
      <main className="flex-1 flex flex-col items-center justify-center p-4 overflow-y-auto relative">
        
        {/* Step 1: Lookup View */}
        {step === 1 && (
          <div className="w-full max-w-md animate-in fade-in slide-in-from-bottom-8 duration-500">
            <div className="bg-white rounded-[2.5rem] shadow-2xl p-8 mb-6 text-center border border-slate-100">
              <div className="mb-6 flex justify-center">
                <div className="w-20 h-20 bg-blue-50 text-[#1E3A8A] rounded-[2rem] flex items-center justify-center shadow-inner">
                  <User size={40} />
                </div>
              </div>
              <h2 className="text-2xl font-black mb-1 text-slate-800">참석자 확인</h2>
              <p className="text-slate-400 mb-8 text-sm font-medium tracking-tight">휴대폰 번호 뒷자리 4자리를 입력하세요</p>
              
              <div className="flex justify-center gap-3 mb-10">
                {[0, 1, 2, 3].map(i => (
                  <div key={i} className={`w-14 h-18 border-b-4 rounded-2xl flex items-center justify-center text-3xl font-black transition-all ${inputValue[i] ? 'border-[#1E3A8A] bg-blue-50 text-[#1E3A8A]' : 'border-slate-100 bg-slate-50 text-slate-200'}`}>
                    {inputValue[i] || ''}
                  </div>
                ))}
              </div>

              {userList.length > 1 && !selectedUser && (
                <div className="mb-6 space-y-2 text-left bg-blue-50 p-5 rounded-3xl border border-blue-100 animate-in bounce-in">
                  <p className="text-[10px] font-black text-blue-800 mb-2 uppercase tracking-widest">번호 중복 - 이름을 선택하세요</p>
                  {userList.map(u => (
                    <button
                      key={u.id}
                      onClick={() => { setSelectedUser(u); setStep(2); }}
                      className="w-full p-4 bg-white border border-blue-100 rounded-2xl flex justify-between items-center hover:bg-[#1E3A8A] hover:text-white transition-all group shadow-sm active:scale-95"
                    >
                      <div className="text-left">
                        <span className="font-bold text-lg block">{u.name}</span>
                        <span className="text-[10px] opacity-60 block truncate max-w-[150px]">{u.course}</span>
                      </div>
                      <span className="text-xs opacity-60 group-hover:opacity-100 font-bold">{u.org}</span>
                    </button>
                  ))}
                </div>
              )}

              <div className="grid grid-cols-3 gap-3">
                {[1, 2, 3, 4, 5, 6, 7, 8, 9, 'DEL', 0, 'GO'].map((key) => (
                  <button
                    key={key}
                    onClick={() => key === 'GO' ? handleSearch() : handleKeyClick(key)}
                    disabled={loading}
                    className={`h-16 rounded-2xl text-xl font-bold transition-all flex items-center justify-center
                      ${key === 'GO' ? 'bg-[#1E3A8A] text-white shadow-xl active:scale-90' : 'bg-slate-100 text-slate-700 active:bg-slate-200'}
                      ${key === 'DEL' ? 'text-red-400' : ''}
                      ${loading ? 'opacity-50' : ''}
                    `}
                  >
                    {key === 'GO' ? (loading ? <Loader2 className="animate-spin" /> : <Search />) : key}
                  </button>
                ))}
              </div>
            </div>
          </div>
        )}

        {/* Step 2: Signature View */}
        {step === 2 && selectedUser && (
          <div className="w-full max-w-lg animate-in fade-in zoom-in-95">
            <div className="bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border border-slate-100">
              <div className="p-8 bg-[#1E3A8A] text-white flex items-center justify-between">
                <div>
                  <p className="text-blue-300 text-[10px] font-black mb-1 uppercase tracking-tighter">{selectedUser.course}</p>
                  <h3 className="text-3xl font-black">{selectedUser.name} <span className="text-lg font-normal opacity-80">선생님</span></h3>
                  <p className="text-blue-100 mt-1 opacity-70 font-medium">{selectedUser.org}</p>
                </div>
                <button onClick={() => { setStep(1); setSelectedUser(null); }} className="bg-white/10 p-3 rounded-2xl hover:bg-white/20 transition-all">
                  <ArrowLeft size={24} />
                </button>
              </div>

              <div className="p-8">
                <p className="text-slate-500 font-bold mb-4 flex items-center gap-2">
                  <FileSignature size={18} className="text-[#1E3A8A]" /> 본인 확인을 위해 아래에 서명하세요
                </p>

                <div className="relative border-4 border-slate-50 rounded-[2rem] bg-slate-50 overflow-hidden mb-8 shadow-inner">
                  <canvas ref={sigCanvas} className="w-full h-72 cursor-crosshair touch-none bg-white" style={{ touchAction: 'none' }} />
                  <div className="absolute bottom-4 right-4 flex gap-2">
                    <button onClick={() => sigPad.current?.clear()} className="px-4 py-2 bg-white text-slate-400 rounded-xl shadow-md border border-slate-100 flex items-center gap-2 text-sm font-bold active:scale-95 transition-all">
                      <Eraser size={16} /> 초기화
                    </button>
                  </div>
                </div>

                <button
                  onClick={handleRegister}
                  disabled={loading}
                  className="w-full py-6 bg-[#1E3A8A] text-white rounded-[2rem] text-xl font-black flex items-center justify-center gap-3 shadow-2xl shadow-blue-200 active:scale-95 transition-all disabled:opacity-50"
                >
                  {loading ? <Loader2 className="animate-spin" /> : <CheckCircle2 size={24}/>}
                  서명 완료 및 등록
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Step 3: Success View */}
        {step === 3 && (
          <div className="text-center animate-in zoom-in-50 duration-500">
            <div className="w-32 h-32 bg-green-50 text-green-500 rounded-[3rem] flex items-center justify-center mx-auto mb-8 shadow-inner">
              <CheckCircle2 size={64} />
            </div>
            <h2 className="text-4xl font-black mb-4 text-slate-800 tracking-tight">등록 완료!</h2>
            <p className="text-slate-400 text-lg font-medium">정상적으로 등록되었습니다. 입장해 주세요.</p>
          </div>
        )}

        {/* Step 4: Admin Dashboard View */}
        {step === 4 && (
          <div className="w-full max-w-6xl h-full flex flex-col animate-in fade-in">
            <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
              <div>
                <h2 className="text-3xl font-black text-[#1E3A8A] flex items-center gap-3 tracking-tighter uppercase">
                  <LayoutDashboard size={32} /> Management
                </h2>
                <p className="text-slate-400 text-sm mt-1 font-medium italic">Smart Registration Admin Panel</p>
              </div>
              <div className="flex gap-2 w-full md:w-auto">
                {adminTab === 'logs' && (
                  <button 
                    onClick={exportRegistrationBook}
                    className="flex-1 md:flex-none px-6 py-3 bg-green-600 text-white rounded-2xl flex items-center justify-center gap-2 font-bold hover:bg-green-700 shadow-lg transition-all active:scale-95"
                  >
                    <Download size={20} /> 등록부 출력 (Excel)
                  </button>
                )}
                <button onClick={() => setStep(1)} className="px-6 py-3 bg-slate-200 text-slate-700 rounded-2xl font-bold hover:bg-slate-300 transition-all active:scale-95">나가기</button>
              </div>
            </div>

            {/* Admin Tabs Navigation */}
            <div className="flex gap-2 mb-6 p-1.5 bg-slate-200/50 rounded-2xl w-fit">
              <button onClick={() => setAdminTab('management')} className={`px-6 py-3 rounded-xl font-bold flex items-center gap-2 transition-all ${adminTab === 'management' ? 'bg-white text-[#1E3A8A] shadow-md' : 'text-slate-500 hover:text-slate-700'}`}>
                <Users size={18} /> 연수 대상자 관리
              </button>
              <button onClick={() => setAdminTab('logs')} className={`px-6 py-3 rounded-xl font-bold flex items-center gap-2 transition-all ${adminTab === 'logs' ? 'bg-white text-[#1E3A8A] shadow-md' : 'text-slate-500 hover:text-slate-700'}`}>
                <FileSignature size={18} /> 등록 및 서명 확인
              </button>
            </div>

            {/* Admin Tab: Management Content */}
            {adminTab === 'management' && (
              <div className="animate-in slide-in-from-left-4 flex flex-col flex-1 overflow-hidden">
                <div className="bg-white rounded-3xl shadow-lg border border-slate-100 p-6 mb-6">
                  <div className="flex items-center gap-3 mb-4 text-[#1E3A8A] font-bold">
                    <Settings size={20} />
                    <h3>프로그램 및 과정 통합 설정</h3>
                  </div>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                      <label className="text-[10px] uppercase font-black text-slate-400 mb-1 block">현재 등록 프로그램 명칭</label>
                      <input type="text" value={programName} onChange={(e) => setProgramName(e.target.value)}
                        className="w-full h-11 bg-slate-50 border border-slate-100 rounded-xl px-4 font-bold text-slate-700 focus:border-[#1E3A8A] outline-none transition-all"
                      />
                    </div>
                    <div>
                      <label className="text-[10px] uppercase font-black text-slate-400 mb-1 block">기본 과정명 (신규 등록 시 적용)</label>
                      <input type="text" value={defaultCourse} onChange={(e) => setDefaultCourse(e.target.value)}
                        className="w-full h-11 bg-slate-50 border border-slate-100 rounded-xl px-4 font-bold text-slate-700 focus:border-[#1E3A8A] outline-none transition-all"
                      />
                    </div>
                  </div>

                  {/* Course Sync Logic UI */}
                  {existingCourses.length > 0 && (
                    <div className="mt-6 pt-6 border-t border-slate-50">
                      <label className="text-[10px] uppercase font-black text-blue-400 mb-3 block tracking-widest">Global Course Sync (DB 일괄 변경)</label>
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                        {existingCourses.map(course => (
                          <div key={course} className="flex gap-2">
                            <input 
                              type="text" 
                              value={courseEditMap[course] ?? course} 
                              onChange={(e) => setCourseEditMap({...courseEditMap, [course]: e.target.value})}
                              className="flex-1 h-10 bg-slate-50 border border-slate-100 rounded-xl px-3 text-sm font-bold text-slate-600 focus:border-[#1E3A8A] outline-none transition-all"
                            />
                            {courseEditMap[course] && courseEditMap[course] !== course && (
                              <button 
                                onClick={() => handleCourseGlobalUpdate(course)}
                                className="px-3 bg-blue-600 text-white rounded-xl shadow-md hover:bg-blue-700 active:scale-95 transition-all"
                              >
                                <RefreshCw size={14} />
                              </button>
                            )}
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>

                <div className="bg-white rounded-[2rem] shadow-xl border border-slate-100 flex flex-col flex-1 overflow-hidden relative">
                  <div className="p-6 border-b border-slate-50 flex flex-col sm:flex-row justify-between items-start sm:items-center bg-slate-50/50 gap-4">
                    <div className="flex items-center gap-3">
                      <h3 className="font-bold text-slate-700 flex items-center gap-2 uppercase tracking-tight">Database <span className="bg-slate-200 text-slate-600 px-2 py-0.5 rounded-lg text-[10px] font-black">{trainees.length}</span></h3>
                      {selectedIds.length > 0 && (
                        <button 
                          onClick={deleteSelectedTrainees}
                          className="flex items-center gap-2 px-3 py-1.5 bg-red-50 text-red-600 rounded-xl text-xs font-black hover:bg-red-500 hover:text-white transition-all animate-in zoom-in"
                        >
                          <Trash2 size={14} /> 선택 삭제 ({selectedIds.length})
                        </button>
                      )}
                    </div>
                    <div className="flex gap-2 w-full sm:w-auto">
                      <button 
                        onClick={() => setIsAddingManually(!isAddingManually)}
                        className={`flex-1 sm:flex-none px-4 py-2 border-2 rounded-xl text-sm font-bold flex items-center justify-center gap-2 transition-all ${isAddingManually ? 'bg-slate-800 border-slate-800 text-white' : 'border-slate-100 text-slate-600 hover:bg-slate-50'}`}
                      >
                        <UserPlus size={16} /> {isAddingManually ? '취소' : '개별 추가'}
                      </button>
                      <input type="file" ref={fileInputRef} onChange={handleFileUpload} className="hidden" accept=".xlsx, .xls, .csv" />
                      <button onClick={() => fileInputRef.current?.click()} className="flex-1 sm:flex-none px-4 py-2 bg-[#1E3A8A] text-white rounded-xl text-sm font-bold flex items-center justify-center gap-2 hover:bg-blue-800">
                        <Upload size={16} /> 엑셀 업로드
                      </button>
                    </div>
                  </div>

                  {/* Individual Entry Section */}
                  {isAddingManually && (
                    <div className="p-6 bg-blue-50/30 border-b-2 border-blue-100 animate-in slide-in-from-top-4">
                      <div className="grid grid-cols-1 md:grid-cols-4 gap-3">
                        <input placeholder="성함" className="h-11 px-4 rounded-xl border border-white focus:border-[#1E3A8A] outline-none font-bold text-sm bg-white" value={newTrainee.name} onChange={e => setNewTrainee({...newTrainee, name: e.target.value})} />
                        <input placeholder="소속" className="h-11 px-4 rounded-xl border border-white focus:border-[#1E3A8A] outline-none font-bold text-sm bg-white" value={newTrainee.org} onChange={e => setNewTrainee({...newTrainee, org: e.target.value})} />
                        <input placeholder="전화번호" className="h-11 px-4 rounded-xl border border-white focus:border-[#1E3A8A] outline-none font-bold text-sm bg-white" value={newTrainee.phone} onChange={e => setNewTrainee({...newTrainee, phone: e.target.value})} />
                        <div className="flex gap-2">
                          <input placeholder="과정명" className="flex-1 h-11 px-4 rounded-xl border border-white focus:border-[#1E3A8A] outline-none font-bold text-sm bg-white" value={newTrainee.course} onChange={e => setNewTrainee({...newTrainee, course: e.target.value})} />
                          <button onClick={addIndividualTrainee} className="bg-[#1E3A8A] text-white px-4 rounded-xl font-bold flex items-center gap-2 active:scale-95 transition-all"><Save size={18}/>저장</button>
                        </div>
                      </div>
                    </div>
                  )}

                  <div className="flex-1 overflow-y-auto">
                    <table className="w-full text-left">
                      <thead className="sticky top-0 bg-white shadow-sm z-10 border-b">
                        <tr className="text-slate-400 text-[10px] uppercase tracking-widest font-black">
                          <th className="p-5 w-12 text-center">
                            <input 
                              type="checkbox" 
                              className="w-5 h-5 rounded border-2 border-slate-200 text-[#1E3A8A] focus:ring-[#1E3A8A]"
                              checked={trainees.length > 0 && selectedIds.length === trainees.length}
                              onChange={toggleSelectAll}
                            />
                          </th>
                          <th className="p-5">성함</th>
                          <th className="p-5">소속</th>
                          <th className="p-5">전화번호</th>
                          <th className="p-5">과정명</th>
                          <th className="p-5 text-right">관리</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-slate-50">
                        {trainees.map(t => (
                          <tr key={t.id} 
                              className={`transition-all ${editingId === t.id ? 'bg-blue-50 shadow-inner' : 'hover:bg-slate-50 cursor-pointer'} ${selectedIds.includes(t.id) ? 'bg-blue-50/40' : ''}`}
                              onClick={() => editingId !== t.id && !isAddingManually && startEditing(t)}
                          >
                            {editingId === t.id ? (
                              <>
                                <td className="p-4" onClick={(e) => e.stopPropagation()}></td>
                                <td className="p-4"><input className="w-full h-10 px-3 border border-blue-200 rounded-lg outline-none focus:border-[#1E3A8A] font-bold text-sm" value={editFormData.name} onChange={e => setEditFormData({...editFormData, name: e.target.value})} /></td>
                                <td className="p-4"><input className="w-full h-10 px-3 border border-blue-200 rounded-lg outline-none focus:border-[#1E3A8A] font-bold text-sm" value={editFormData.org} onChange={e => setEditFormData({...editFormData, org: e.target.value})} /></td>
                                <td className="p-4"><input className="w-full h-10 px-3 border border-blue-200 rounded-lg outline-none focus:border-[#1E3A8A] font-bold text-sm font-mono" value={editFormData.phone} onChange={e => setEditFormData({...editFormData, phone: e.target.value})} /></td>
                                <td className="p-4"><input className="w-full h-10 px-3 border border-blue-200 rounded-lg outline-none focus:border-[#1E3A8A] font-bold text-sm" value={editFormData.course} onChange={e => setEditFormData({...editFormData, course: e.target.value})} /></td>
                                <td className="p-4 text-right flex justify-end gap-2 mt-2" onClick={(e) => e.stopPropagation()}>
                                  <button onClick={saveEdit} className="p-2 bg-green-500 text-white rounded-lg shadow-sm active:scale-95 transition-all"><Save size={16}/></button>
                                  <button onClick={() => setEditingId(null)} className="p-2 bg-slate-300 text-white rounded-lg shadow-sm active:scale-95 transition-all"><X size={16}/></button>
                                </td>
                              </>
                            ) : (
                              <>
                                <td className="p-5 text-center" onClick={(e) => { e.stopPropagation(); toggleSelectOne(t.id); }}>
                                  <input 
                                    type="checkbox" 
                                    className="w-5 h-5 rounded border-2 border-slate-200 text-[#1E3A8A] focus:ring-[#1E3A8A]"
                                    checked={selectedIds.includes(t.id)}
                                    readOnly
                                  />
                                </td>
                                <td className="p-5 font-black text-slate-800">{t.name}</td>
                                <td className="p-5 text-slate-500 text-sm font-medium">{t.org}</td>
                                <td className="p-5 font-mono text-slate-500 text-sm">{t.phone}</td>
                                <td className="p-5"><span className="text-[10px] bg-slate-100 text-slate-600 px-2.5 py-1 rounded-full font-black uppercase tracking-tight">{t.course}</span></td>
                                <td className="p-5 text-right" onClick={(e) => e.stopPropagation()}>
                                  <div className="flex justify-end gap-1">
                                    <button onClick={() => startEditing(t)} className="p-2 text-slate-300 hover:text-[#1E3A8A] hover:bg-blue-50 rounded-lg transition-all"><Edit2 size={16}/></button>
                                    <button onClick={() => setTrainees(prev => prev.filter(item => item.id !== t.id))} className="p-2 text-red-100 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all"><Trash2 size={16}/></button>
                                  </div>
                                </td>
                              </>
                            )}
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            )}

            {/* Admin Tab: Registration Logs View */}
            {adminTab === 'logs' && (
              <div className="bg-white rounded-[2rem] shadow-xl border border-slate-100 flex flex-col flex-1 overflow-hidden animate-in slide-in-from-right-4">
                <div className="p-6 border-b border-slate-50 bg-slate-50/50">
                  <h3 className="font-bold text-slate-700 flex items-center gap-2 uppercase tracking-tight">Registration Logs <span className="bg-green-100 text-green-600 px-2 py-0.5 rounded-lg text-[10px] font-black">{registrations.length}</span></h3>
                </div>
                <div className="flex-1 overflow-y-auto">
                  <table className="w-full text-left">
                    <thead className="sticky top-0 bg-white shadow-sm z-10 border-b">
                      <tr className="text-slate-400 text-[10px] uppercase tracking-widest font-black">
                        <th className="p-5">등록시간</th>
                        <th className="p-5">과정명</th>
                        <th className="p-5">성함</th>
                        <th className="p-5">소속</th>
                        <th className="p-5 text-center">서명</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-50">
                      {registrations.map((r, idx) => (
                        <tr key={idx} className="hover:bg-green-50/20 transition-colors group">
                          <td className="p-5 text-[10px] text-slate-400 font-mono font-bold">{r.regTime}</td>
                          <td className="p-5"><span className="text-[10px] font-black opacity-30 uppercase tracking-tighter group-hover:opacity-100 transition-opacity">{r.course}</span></td>
                          <td className="p-5 font-black text-[#1E3A8A]">{r.name}</td>
                          <td className="p-5 text-slate-500 text-sm font-medium">{r.org}</td>
                          <td className="p-5 flex justify-center">
                            <div onClick={() => setViewSignature(r.signature)} className="w-20 h-10 bg-slate-50 border-2 border-slate-100 rounded-xl flex items-center justify-center cursor-pointer hover:border-[#1E3A8A] hover:bg-white shadow-sm transition-all overflow-hidden">
                              {r.signature ? <img src={r.signature} alt="서명" className="max-h-full" /> : <Eye size={14} className="text-slate-200" />}
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            )}
          </div>
        )}
      </main>

      <footer className="p-4 text-center text-slate-300 text-[10px] tracking-[0.3em] font-black uppercase shrink-0 bg-white border-t border-slate-50">
        &copy; 2024 Smart Sign-In Solution. Precision & Integrity.
      </footer>
    </div>
  );
};

export default App;
